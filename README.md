# Identity Service Helper

Core delivery C# ASP.NET backend template.

* [Install MongoDB](#install-mongodb)
* [Inspect MongoDB](#inspect-mongodb)
* [Testing](#testing)
* [Running](#running)
* [Dependabot](#dependabot)


### Docker Compose

A Docker Compose template is in [compose.yml](compose.yml).

A local environment with:

- Localstack for AWS services (S3, SQS)
- Redis
- MongoDB
- Postgres
- This service.
- A commented out frontend example.

```bash
docker compose up --build -d
```

### PostgreSQL

The database is configured to use PostgreSQL and to use Liquibase to manage migrations.

Thew best way to run liquibase locally is to use Homebrew to install
```shell
brew install liquibase
```

> Liquibase properties file in the root of the project defines all the properties that can be used 
> to configure the database.

Liquibase is a Java based tool that can be used to manage database migrations. Therefore you will need to have Java 
installed. On both Linux and MacOS you can install Java using Homebrew.

```shell
  brew install openjdk@25
```

Running liquibase migrations locally:
 

``` bash
 liquibase update 

```

### How to do create Database Migrations

On this project we make use of a Hybrid approach to database migrations, making use of **Liquibase** to manage the database 
schema and  **Entity Framework Core Migrations**.  This may at first seem counter-intuitive, but it has proven to be a 
reliable approach, although it does require some additional configuration and manual steps.

If you make changes to the database schema, you will need to create a new migration.

To create a new migration, change into the `~src/Database` directory and run dotnet ef migrations as follows:

```bash
cd src/Database
dotnet ef migrations add <migration-name>    ### <Migration-name> to be replaced with a meaningful name  i.e. AddDeltaTable

````
The above command will create a new migration in the `Migrations` directory, within the Database project.
In the Database folder there is a Console Application project named `Postgres.Database.Console` that can be run that will
exexcute the migration to your local database.

The Console application will then automatically apply this migration to the database. In the Local Development environment, if
the project is run.   There is code within the `ServiceCollectionExtensions` class that will automatically apply the
migrations to the database on Debug builds.

``` csharp
   #if DEBUG
    // Migrate the database on startup in development mode
     if (scope.ServiceProvider.GetRequiredService<IHostEnvironment>().IsDevelopment())
     {
       context.Database.Migrate();
     }
    #endif
 ```

> Note: We still need to run the migrations locally, to test migrations. etc.

Once you are satisfied with the migration, and it works and has been tested, locally,
and you have created Unit Tests etc.  You can then generate a SQL script using 
EF Core Migrations script command, defining the output folder as the schema folder in the project.

```bash
### <meaningful-name> to be replaced with a meaningful name  i.e. AddDeltaTable
 dotnet ef migrations script  <meaningful-name> -o ../../database/schema/<meaningful-name>.sql

```
This will generate a SQL script that can be used to apply the migration to a production environment. However,
before the script is applied there may be some manual steps required to edit the file.

> Note: The SQL script generated by EF Core Migrations script command will include statements that cannot be used in Liquibase
> migration scripts.

Once you have edited your script to make it parseable and usable in Liquibase. Then you can add the script to the Liquibase
changelog file.

``` bash

# Remove any references to Migrations table creations etc

CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
    "MigrationId" character varying(150) NOT NULL,
    "ProductVersion" character varying(32) NOT NULL,
    CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId")
);


# Remove any Transaction Scope statements
# Liquibase will wrap everything in a transaction scope by default 

START TRANSACTION;
DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'defra-ci') THEN
        CREATE SCHEMA "defra-ci";
    END IF;
END $EF$;

## Should just become 
 CREATE SCHEMA "defra-ci";
```

A more extensive setup is available in [github.com/DEFRA/cdp-local-environment](https://github.com/DEFRA/cdp-local-environment)

### MongoDB

#### MongoDB via Docker

See above.

```
docker compose up -d mongodb
```

#### MongoDB locally

Alternatively install MongoDB locally:

- Install [MongoDB](https://www.mongodb.com/docs/manual/tutorial/#installation) on your local machine
- Start MongoDB:
```bash
sudo mongod --dbpath ~/mongodb-cdp
```

#### MongoDB in CDP environments

In CDP environments a MongoDB instance is already set up
and the credentials exposed as enviromment variables.


### Inspect MongoDB

To inspect the Database and Collections locally:
```bash
mongosh
```

You can use the CDP Terminal to access the environments' MongoDB.

### Testing

Run the tests with:

Tests run by running a full `WebApplication` backed by [Ephemeral MongoDB](https://github.com/asimmon/ephemeral-mongo).
Tests do not use mocking of any sort and read and write from the in-memory database.

```bash
dotnet test
````

### Running

Run CDP-Deployments application:
```bash
dotnet run --project IdentityServiceHelper --launch-profile Development
```

### SonarCloud

Example SonarCloud configuration are available in the GitHub Action workflows.

### Dependabot

We have added an example dependabot configuration file to the repository. You can enable it by renaming
the [.github/example.dependabot.yml](.github/example.dependabot.yml) to `.github/dependabot.yml`


### About the licence

The Open Government Licence (OGL) was developed by the Controller of Her Majesty's Stationery Office (HMSO) to enable
information providers in the public sector to license the use and re-use of their information under a common open
licence.

It is designed to encourage use and re-use of information freely and flexibly, with only a few conditions.

### HTTP Client Tests
To run HTTP Client tests locally,  you can use the [ijhttp](https://github.com/asimmon/ijhttp) tool.
on Mac/Linux install using `brew install ijhttp`   on Windows use chocolatey `choco install ijhttp`
Then run the following command from the root of the project.
```shell
ijhttp --env-file ./tests/Endpoint.Tests/Tests/http-client.env.json --env local ./tests/Endpoint.Tests/**/**/**.http
```